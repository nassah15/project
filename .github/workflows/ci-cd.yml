name: CI-CD (ECR â†’ EKS)

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
  CLUSTER_NAME: ${{ vars.EKS_CLUSTER_NAME }}

  ECR_BACKEND: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com/${{ vars.ECR_BACKEND_REPO }}
  ECR_FRONTEND: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com/${{ vars.ECR_FRONTEND_REPO }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-ecr-eks
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push backend
        run: |
          docker build -t $ECR_BACKEND:${GITHUB_SHA} ./ecommerce-backend
          docker push $ECR_BACKEND:${GITHUB_SHA}

      - name: Build & push frontend
        run: |
          docker build -t $ECR_FRONTEND:${GITHUB_SHA} ./ecommerce-frontend
          docker push $ECR_FRONTEND:${GITHUB_SHA}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $CLUSTER_NAME

      - name: Deploy with Helm
        run: |
          helm upgrade --install ecommerce ./helm/ecommerce \
            -f helm/ecommerce/values.yaml \
            -f helm/ecommerce/values-eks.yaml \
            --set backend.image.repository=$ECR_BACKEND \
            --set backend.image.tag=${GITHUB_SHA} \
            --set frontend.image.repository=$ECR_FRONTEND \
            --set frontend.image.tag=${GITHUB_SHA}
